<!doctype html>
<html lang="en-us" class=scroll-smooth data-default-appearance=light data-auto-appearance=true>
  <head>
    
    <!-- Clicky -->
    <script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101320555);</script>
    <script async src="//static.getclicky.com/js"></script>
    <!-- Clicky -->
    <meta charset="utf-8">
    <title>Luca's blog - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Luca Cambiaghi" />
    <meta name="description" content="Luca&#39;s blog" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://lucacambiaghi.com/static/style.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <script async src="https://talk.hyvor.com/embed/embed.js" type="module"></script>
    <script type=text/javascript src="https://lucacambiaghi.com/static//js/appearance.js"></script>
    <script defer type=text/javascript id=script-bundle src="https://lucacambiaghi.com/static//js/main.js" data-copy=Copy data-copied=Copied></script>
    
  </head>

  <body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl">
    
    <div id=the-top class="absolute flex self-center">
  <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content>
    <span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;
    </span>Skip to main content
  </a>
</div>

<header class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral print:hidden">
  <div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/index.html">Luca</a></div>
<nav>
  <ul class="flex list-none sm:flex-row">
    <li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
      <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/posts.html">posts</a>
    </li>
    <span class="px-2 text-primary-500">&#183;</span>
    <li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
      <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/emacsd.html">emacs</a>
    </li>
    <span class="px-2 text-primary-500">&#183;</span>
    <li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
      <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/nix.html">nix</a>
    </li>
  </ul>
</nav>
</header>

    

    <main id="main" class="relative grow">
      
<article class="post">
  <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
    Doom gccemacs on MacOS
  </h1>
  <div class="mt-8 mb-8 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
    <div class="flex flex-row flex-wrap items-center">
      <time> Oct 03, 2020
      </time>
      <span class="px-2 text-primary-500">&#183;</span>
      <span title="tags">(emacs macos doom)
      </span>
    </div>
  </div>

  <section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert">
    <div class="min-w-0 min-h-0 max-w-prose">
      
<div id="outline-container-orgaeb1aae" class="outline-2">
<h2 id="orgaeb1aae">Emacs is born</h2>
<div class="outline-text-2" id="text-orgaeb1aae">
<p>
The first time I saw Emacs was on the ThinkPad of my Master Thesis' supervisor.
He was coding in R and he had split the screen in two parts, writing code to the left, evaluating it to see the results in the REPL on the right.
I was impressed by it, my setup at the time consisted of Jupyter Notebooks for exploration, Visual Studio to write LaTeX, Pycharm to debug and deploy batch jobs to the VM.
</p>

<p>
Little did I know that 2 years later I would have <b>integrated</b> my worfklow into one editor, the very same one he was using.
Another colleague of mine was using Emacs and when pair programming with him I was again struck by his workflow and some of the features of its editor.
One weekend, almost joking, I downloaded vanilla Emacs and I followed the tutorial.
</p>

<p>
Maaan, these weird keybindings.
Now I know that Emacs has been developed before the <a href="https://www.ibm.com/support/knowledgecenter/SSLTBW_2.1.0/com.ibm.zos.v2r1.f54dg00/cuahlp.htm">Common User Access</a> guidelines were designed.
Its philoshopy allows the user to change keybindings to whatever you expect from it but it won't suggest it to you!
</p>

<p>
Of course I did not know how easy it would be to configure <code>cua-mode</code> in case I wanted standard <code>s-x</code>, <code>s-v</code> bindings to copy and paste.
However, on the same day I discovered that a popular alternative to the vanillla keybindings was the so-called <code>evil-mode</code>.
The power of <code>vim</code>'s modal editing and the expressivity of the <code>lisp</code> machine.
</p>

<p>
Very soon I learned about Emacs "distributions" or "starter kits".
The most popular is Spacemacs: it comes configured with all the "cool" packages, among them <code>evil-mode</code>.
I then spent weeks learning about Spacemacs, Emacs and <code>emacs-lisp</code>.
</p>

<p>
I will have to write another blog post to celebrate all my achievements with Emacs.
This one will just bedicated to the configuration of it.
</p>
</div>
</div>

<div id="outline-container-org1bcb0e8" class="outline-2">
<h2 id="org1bcb0e8">Doom</h2>
<div class="outline-text-2" id="text-org1bcb0e8">
<p>
Some of Spacemacs qualities:
</p>
<ul class="org-ul">
<li>Spacemacs is well documented and perfect for a first Emacs user.</li>
<li>It is a community effort, things movest fast. Maybe too fast, looking at the number of open issues.</li>
<li>It is feature complete. Maybe too complete, someone would argue it is slow.</li>
<li>It abstracts away much of the complexity of Emacs. Maybe a bit too much, I would sometimes learn Spacemacs specific terminology but not so much <code>elisp</code>.</li>
</ul>

<p>
Beacuse I am curios, I decided to try the second most popular Emacs distribution: <a href="https://github.com/hlissner/doom-emacs">Doom</a> (I am still not amused by the name).
Here some of its qualities:
</p>
<ul class="org-ul">
<li>Doom is not a comunity effort like Spacemacs but is mantained by one person, very active and helpful.</li>
<li>There is a great community of users on <a href="https://discord.gg/qvGgnVx">Discord</a>, helpful and respectful.</li>
<li>It is modular and completely configurable. The default configuration for the available modules is always well thought.</li>
<li>It is carefully designed with performance in mind.</li>
<li>It is much closer to the <code>elisp</code> metal. It offers cool macros to rebind keys, to install packages, etc.</li>
</ul>

<p>
Thanks to Doom I started to <b>configure</b> my editor and not just to rely on other people's modules.
I finally learned to inspect Emacs by describing functions and variables.
I learned about modes, hooks, advices.
I wrote some simple elisp functions to add features I needed.
<a href="https://lccambiaghi.github.io/.doom.d/readme.html">Here</a> you can see an HTML render of my config.
</p>
</div>
</div>

<div id="outline-container-org9141f2f" class="outline-2">
<h2 id="org9141f2f">gccemacs</h2>
<div class="outline-text-2" id="text-org9141f2f">
<p>
The Doom Emacs community is active on Discord, here is where I hear about the latest trends.
Lately (August 2020) the latest trend has definitely been <a href="https://www.emacswiki.org/emacs/GccEmacs">gccemacs</a>.
This is a development branch of Emacs HEAD which compiled elisp code to native code, bringing huge performance benefits.
</p>

<p>
Emacs is often accused of being slow compared to modern editors.
The dynamic nature of the <code>elisp</code> machine makes it by nature slower than the compiled counterparts.
This clever solution has gained popularity lately, so much that it has been announced it will be merged into master.
</p>

<p>
During these COVID times our team is working from home.
My work laptop is a dual core MacBook Pro, which has some performance issues when I am screen sharing and programming with Emacs.
One day I decided I had to try it. It was worth it.
</p>

<p>
I used <a href="https://github.com/jimeh/build-emacs-for-macos">this repo</a> to build Emacs 28, <code>feature/native-comp</code> branch.
After cloning it, I first had to install a patched <code>gcc</code> version:
</p>
<div class="org-src-container">
<pre class="src src-sh">./install-patched-gcc
</pre>
</div>
<p>
I had some installation issues which were solved by updating to the latest Apple's Command Line Tools.
You can do that with:
</p>
<div class="org-src-container">
<pre class="src src-sh">xcode-select --install
</pre>
</div>

<p>
Once <code>gcc</code> was installed, I could build Emacs 28 with:
</p>
<div class="org-src-container">
<pre class="src src-sh">./build-emacs-for-macos --git-sha 3023eb569213a3dd5183640f6e322acd00ea536a feature/native-comp
</pre>
</div>
<p>
You should pick a recent git sha by looking at <a href="https://github.com/jimeh/build-emacs-for-macos/issues/6">this issue</a> which tracks "good commits" that lead to stable versions.
</p>

<p>
I then replaced my previous Emacs.app with the one just built.
Maybe that won't work for everybody, it depends how you installed Emacs27.
My previous installation was this tap of <code>emacs-plus</code>:
</p>
<div class="org-src-container">
<pre class="src src-sh">brew tap d12frosted/emacs-plus
</pre>
</div>
<p>
And this are the install options:
</p>
<div class="org-src-container">
<pre class="src src-sh">brew install emacs-plus --without-spacemacs-icon --HEAD --with-emacs-27-branch --with-jansson --with-modern-icon
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfc766f8" class="outline-2">
<h2 id="orgfc766f8">Gotchas</h2>
<div class="outline-text-2" id="text-orgfc766f8">
<p>
Doom Emacs already unofficially kind of supports <code>gccemacs</code>.
I just replaced my Emacs.app with the new one and had to run:
</p>
<div class="org-src-container">
<pre class="src src-sh">doom sync &amp;&amp; doom build
</pre>
</div>
<p>
And wait for the compilation jobs to finish.
</p>

<p>
Once that was done I faced a few issues, which were not exactly well documented.
After running a second <code>doom sync</code> my Emacs failed to start with an error about some misteryous magit variable.
I found the solution on Discord: the guilty is a compiled autoloads file:
</p>
<div class="org-src-container">
<pre class="src src-sh">rm -rf ~/.emacs.d/local/cache/eln/x86_64-apple-darwin19.5.0-8b26f6d2e293e8b6/autoloads*.eln
</pre>
</div>

<p>
Another important remark: Emacs 28 is unstable and some packages don't support it yet.
My workflow relies heavily on two packages: <code>emacs-jupyter</code> and <code>dap-mode</code>.
Both of them were broken after the update.
</p>

<p>
When I tried to run <code>emacs-jupyter</code> in an <code>.org</code> file I was asked to download the <code>zmq</code> module, to which I agreed.
But then the installation broke because of a missing file.
I found the solution on a remote github issue: I had to change the extension of the downloaded <code>.so</code> file:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">cd</span> ~/.emacs.d/.local/straight/build/emacs-zmq
cp emacs-zmq.so emacs-zmq.dylib
</pre>
</div>

<p>
To fix <code>dap-mode</code> I had to unpin few packages to enable the support of Emacs 28.
In fact, Doom locks pacakges to specific versions to make sure nothing breaks on the stable version (Emacs 27).
All I had to do was to write:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(unpin! dap-mode lsp-mode treemacs)
</pre>
</div>
<p>
In my <code>.doom.d/packages.el</code>.
</p>

<p>
I hope some early adopter can find this blog post and solve some of his installation/configuration issues with these solutions!
</p>
</div>
</div>

    </div>
  </section>

  <section>
    <div id="hyvor-talk-view"></div>
    <hyvor-talk-comments website-id="793" page-id="doom-emacs"></hyvor-talk-comments>
  </section>

  <!-- <div class="absolute top-[110vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-[-5.5rem]"> -->
  <!--   <a href="#the-top" class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">↑</a> -->
  <!-- </div> -->

</article>

    </main>

    <footer class="py-10 print:hidden">
      
      <div class="flex justify-between">
  <div>
    <p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
      Luca Cambiaghi
    </p>
    <p class="text-xs text-neutral-500 dark:text-neutral-400">Theme inspired by
      <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target=_blank rel="noopener noreferrer">Congo</a>
    </p>
  </div>
  <div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14">
    <button id=appearance-switcher class="w-12 h-12" type=button title="Switch to dark appearance">
      <span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div>

      
    </footer>

  </body>
</html>
