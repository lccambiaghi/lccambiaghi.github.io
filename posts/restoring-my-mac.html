<!doctype html>
<html lang="en-us" class=scroll-smooth data-default-appearance=light data-auto-appearance=true>
  <head>
    
    <!-- Clicky -->
    <script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101320555);</script>
    <script async src="//static.getclicky.com/js"></script>
    <!-- Clicky -->
    <meta charset="utf-8">
    <title>Luca's blog - Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Luca Cambiaghi" />
    <meta name="description" content="Luca&#39;s blog" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://lucacambiaghi.com/static/style.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <script async src="https://talk.hyvor.com/embed/embed.js" type="module"></script>
    <script type=text/javascript src="https://lucacambiaghi.com/static//js/appearance.js"></script>
    <script defer type=text/javascript id=script-bundle src="https://lucacambiaghi.com/static//js/main.js" data-copy=Copy data-copied=Copied></script>
    
  </head>

  <body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl">
    
    <div id=the-top class="absolute flex self-center">
  <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content>
    <span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;
    </span>Skip to main content
  </a>
</div>

<header class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral print:hidden">
  <div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/index.html">Luca</a></div>
<nav>
  <ul class="flex list-none sm:flex-row">
    <li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
      <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/posts.html">posts</a>
    </li>
    <span class="px-2 text-primary-500">&#183;</span>
    <li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
      <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/emacsd.html">emacs</a>
    </li>
    <span class="px-2 text-primary-500">&#183;</span>
    <li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
      <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/nix.html">nix</a>
    </li>
  </ul>
</nav>
</header>

    

    <main id="main" class="relative grow">
      
<article class="post">
  <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
    Restoring my Mac
  </h1>
  <div class="mt-8 mb-8 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
    <div class="flex flex-row flex-wrap items-center">
      <time> Oct 26, 2020
      </time>
      <span class="px-2 text-primary-500">&#183;</span>
      <span title="tags">(macos emacs)
      </span>
    </div>
  </div>

  <section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert">
    <div class="min-w-0 min-h-0 max-w-prose">
      
<div id="outline-container-setup-org" class="outline-2">
<h2 id="setup-org">setup.org</h2>
<div class="outline-text-2">
<p>
This week-end I restored my Mac.
I was having some major iCloud issues, my Documents and Desktop folders would not sync.
My Mac in general looked really tired.
</p>

<p>
I was prepared.
I took inspiration from a colleague's bash script to write my own configuration script, in <code>org-mode</code>.
This format allows me to organize my <code>sh</code> code blocks within headlines and comments.
I can then <code>tangle</code> the blocks to a file <code>setup.sh</code>, which I can run on the new Mac.
</p>

<p>
I can do this by having this property at the top of <code>setup.org</code>:
</p>
<pre class="example" id="org6923f09">
#+PROPERTY: header-args :tangle ~/git/org/personal/setup.sh
</pre>

<p>
This is the structure of the document:
</p>
<pre class="example" id="org19aebd1">
* macOs settings
* brew
* zsh
* fonts
* cli
* gui
* dotfiles
* execute all
</pre>

<p>
In each section I have a <code>sh</code> code block.
This is an example block from the "gui" section:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-function-name">install_apps</span>() {
    <span class="org-builtin">echo</span> <span class="org-string">"Installing: base apps"</span>
    <span class="org-variable-name">BASE_APPS</span>=<span class="org-string">"google-chrome amethyst slack visual-studio-code firefox iterm2 iina menumeters 1password6 qbitorrent private-internet-access"</span>
    brew tap homebrew/cask-versions
    brew cask install $<span class="org-variable-name">BASE_APPS</span>
    <span class="org-builtin">echo</span> <span class="org-string">"Installing: docker"</span>
    brew cask install docker
    <span class="org-builtin">echo</span> <span class="org-string">"Installing: corporate"</span>
    <span class="org-variable-name">CORPORATE</span>=<span class="org-string">"microsoft-office keybase microsoft-azure-storage-explorer intune-company-portal microsoft-teams"</span>
    brew cask install $<span class="org-variable-name">CORPORATE</span>
}
</pre>
</div>

<p>
I can "export" the <code>org</code> file to <code>setup.sh</code> with <code>M-x org-babel-tangle</code>.
</p>
</div>
</div>

<div id="outline-container-recovery-mode-and-setup-sh" class="outline-2">
<h2 id="recovery-mode-and-setup-sh">Recovery Mode and setup.sh</h2>
<div class="outline-text-2">
<p>
Before erasing all content gathered in 12 months, I quickly offloaded some files to a USB key.
I mostly cared about an "AI for trading" course and some work analyses not in version control.
</p>

<p>
Without thinking too much, I booted in Recovery Mode with cmd+R, erase the HD and reinstalled.
(I found out later that I forgot about my <code>.gnupg</code> folder with my private <code>gpg</code> key..)
</p>

<p>
While running my <code>install.sh</code> script, I realized my main needs:
</p>
<ul class="org-ul">
<li>Emacs (+ Doom)</li>
<li>Dropbox (org)</li>
<li>Password Manager</li>
</ul>

<p>
I could survive with a browser and Emacs for a week.
Okay, maybe I would need Slack for work but not much else.
</p>

<p>
My first impulse was to rebuild <code>gccemacs</code> on my Mac, in parallel to my already big configuration efforts.
To my surprise, the process has been incredibly easy.
Well, maybe because I have already spent a few hours fighting <code>gccemacs</code> in the past weeks.
</p>

<p>
All I did to install it was to clone <a href="https://github.com/jimeh/build-emacs-for-macos">this</a> repo and run:
</p>
<ol class="org-ol">
<li><code>brew bundle</code></li>
<li><code>./build-emacs-for-macos --git-sha d5791ba5feeb5500433ca43506dda13c7c67ce14 feature/native-comp</code></li>
<li>Move the app to <code>Applications</code>.</li>
</ol>

<p>
In the meanwhile, my <code>install.sh</code> script was having some hiccups.
I got somehow 90% of the functionalities working (loads of <code>brew</code> downloads: CLI tools and GUI apps)
I had to manually copy-paste some commands from the harder sections such as <code>install-zsh</code> and <code>restore-dotfiles</code>.
Overall, I am very satisfied: it really saved a lot of time.
</p>

<p>
Once I had built Emacs, I simply had to reinstall Doom.
On its first run with <code>gccemacs</code>, Doom will now compile AOT all packages, which takes a while.
</p>

<p>
Halfway through, I cloned my Doom configuration (stored in git) to <code>.doom.d</code> and build the extra packages in my config.
With minimal effort, few minutes later, I had restored my feature-complete IDE.
<code>straight</code> and <code>Doom</code> in general is amazing.
</p>
</div>
</div>

<div id="outline-container-last-manual-steps" class="outline-2">
<h2 id="last-manual-steps">Last manual steps</h2>
<div class="outline-text-2">
<p>
I then documented some final manual steps I had forgotten to include in my install script.
Some examples:
</p>
<ul class="org-ul">
<li>Forgot to backup SSH keys&#x2026; <code>ssh-keygen</code></li>
<li>My <a href="https://rstudio.github.io/renv/articles/renv.html">renv</a> library does not work. I had to add <code>export R_LIBS_USER=...</code> to my <code>.zshenv</code></li>
<li>Forgot to install pyright.. <code>brew install node &amp;&amp; npm install -g pyright</code></li>
<li>iTerm2 does not send escape sequences.. follow <a href="https://www.clairecodes.com/blog/2018-10-15-making-the-alt-key-work-in-iterm2/">this</a> guide.</li>
</ul>

<p>
It sounds like a waste of time and a lot of work to start from scratch and fight these issues.
I find it a valuable task that lets me learn about my workflow.
I document it and declare it.
</p>

<p>
I have achieved full reproducibility when it comes to my IDE.
Next step is my full computing environment.
That is why I am now looking at <code>nix</code> and <code>home-manager</code>.
Expect a blog post about it in the near future!
</p>
</div>
</div>

    </div>
  </section>

  <section>
    <div id="hyvor-talk-view"></div>
    <hyvor-talk-comments website-id="793" page-id="restoring-my-mac"></hyvor-talk-comments>
  </section>

  <!-- <div class="absolute top-[110vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-[-5.5rem]"> -->
  <!--   <a href="#the-top" class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">↑</a> -->
  <!-- </div> -->

</article>

    </main>

    <footer class="py-10 print:hidden">
      
      <div class="flex justify-between">
  <div>
    <p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
      Luca Cambiaghi
    </p>
    <p class="text-xs text-neutral-500 dark:text-neutral-400">Theme inspired by
      <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://git.io/hugo-congo" target=_blank rel="noopener noreferrer">Congo</a>
    </p>
  </div>
  <div class="text-sm cursor-pointer text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-14 rtl:ml-14">
    <button id=appearance-switcher class="w-12 h-12" type=button title="Switch to dark appearance">
      <span class="inline dark:hidden"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></span><span class="hidden dark:inline"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></span></button></div></div>

      
    </footer>

  </body>
</html>
